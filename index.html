<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Assistant</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .notebook-container {
            background-color: #fcfcf5;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .text-area {
            background-color: transparent;
            border: none;
            outline: none;
            resize: none;
            font-size: 1.1rem;
            line-height: 1.5rem;
            color: #1a202c;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            min-height: 1.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            min-height: 0; /* Allow flex items to shrink below their content size */
        }
        
        .chat-history-container {
            flex: 1;
            min-height: 0; /* Allow flex items to shrink below their content size */
            overflow-y: auto;
            margin-bottom: 0; /* Remove margin */
        }
        
        #chat-history {
            padding: 20px;
            flex: 1;
            min-height: 150px;
            overflow-y: auto;
        }
        
        .input-container {
            flex-shrink: 0; /* Prevent input area from shrinking */
            background-color: white;
            border-top: 1px solid #e2e8f0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .send-button {
            flex-shrink: 0; /* Prevent send button from shrinking */
            min-width: 44px; /* Minimum touch target size */
            min-height: 44px; /* Minimum touch target size */
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px -1px rgba(0,0,0,0.08);
            position: relative;
            animation: fadeIn 0.5s ease-out;
            border: 1px solid #e2e8f0;
            font-size: 0.95rem;
        }
        .user-message {
            background-color: #e5e5e5;
            align-self: flex-end;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .ai-message {
            background-color: #f0f0f0;
            align-self: flex-start;
            margin-left: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Patrick Hand', cursive;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            min-height: 0; /* Allow flex items to shrink below their content size */
        }
        
        .chat-history-container {
            flex: 1;
            min-height: 0; /* Allow flex items to shrink below their content size */
            overflow-y: auto;
        }
        
        #chat-history {
            padding: 20px;
            flex: 1;
            min-height: 150px;
            overflow-y: auto;
        }
        
        .loading-dots span {
            animation: dot-pulse 1.2s infinite ease-in-out;
        }
        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dot-pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .button-gradient {
            background-image: linear-gradient(135deg, #a37d65 0%, #b28a71 100%);
            border: 2px solid #a37d65;
            transition: all 0.2s ease-in-out;
            color: white;
            font-weight: 600;
        }
        .button-gradient:hover {
            box-shadow: 0 4px 15px rgba(163, 125, 101, 0.4);
            transform: translateY(-2px);
        }
        .clear-btn {
            background-color: #d1d5db;
            color: #4b5563;
        }
        .clear-btn:hover {
            background-color: #9ca3af;
        }
        
        /* Mobile options */
        @media (max-width: 768px) {
            .options-section {
                padding: 0.5rem;
            }
            
            .button-gradient, .clear-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
        
        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .auth-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: #fcfcf5;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: #f8f4f0;
            border-right: 1px solid #e2e8f0;
            padding: 1rem;
            overflow-y: auto;
            display: none;
            position: absolute;
            height: calc(100% - 60px);
            z-index: 10;
            top: 60px;
            left: 0;
        }
        
        .sidebar.open {
            display: block;
        }
        
        /* Mobile sidebar */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: calc(100% - 120px);
                top: 120px;
                z-index: 100;
            }
        }
        
        .history-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }
        
        .history-item:hover {
            background-color: #e2e8f0;
        }
        
        .history-item.active {
            background-color: #a37d65;
            color: white;
        }
        
        .toggle-sidebar-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 100;
            background-color: #a37d65;
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            margin-top: 60px;
            min-height: 0; /* Allow flex items to shrink below their content size */
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            min-height: 0; /* Allow flex items to shrink below their content size */
        }
        
        .chat-history-container {
            flex: 1;
            min-height: 0; /* Allow flex items to shrink below their content size */
            overflow-y: auto;
        }
        
        /* Error message */
        .error-message {
            color: #e53e3e;
            background-color: #fed7d7;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem;
            display: none;
        }
        
        /* Image upload styles */
        .image-preview-container {
            background-color: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        
        .image-message {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .image-message img {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .image-upload-btn {
            transition: all 0.2s ease-in-out;
        }
        
        .image-upload-btn:hover {
            transform: translateY(-1px);
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        /* Welcome message */
        .welcome-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
        
        /* Mobile responsive fixes */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                overflow: hidden;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .notebook-container {
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: calc(100vh - 120px);
                top: 120px;
            }
            
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                height: calc(100vh - 60px);
                margin-top: 60px;
                min-height: 0;
                padding-bottom: 2rem;
            }
            
            .chat-container {
                flex: 1;
                display: flex;
                flex-direction: column;
                height: 100%;
                min-height: 0;
            }
            
            .user-info {
                flex-shrink: 0;
                flex-direction: column;
                align-items: stretch;
                text-align: center;
                padding: 1rem 0.5rem;
            }
            
            .user-info h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .user-info > div {
                display: flex;
                justify-content: center;
                gap: 1rem;
            }
            
            .chat-history-container {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
            }
            
            #chat-history {
                padding: 10px;
                min-height: 100px;
            }
            
            .options-section {
                flex-shrink: 0;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .text-area {
                font-size: 1rem;
                padding: 0.75rem;
                min-height: 2.5rem;
                max-height: 100px;
            }
            
            .input-container {
                flex-shrink: 0;
                padding: 1rem 0.75rem;
                margin-bottom: 1rem;
                background-color: white;
                border-top: 2px solid #e2e8f0;
                border-radius: 12px 12px 0 0;
                position: sticky;
                bottom: 0;
                z-index: 20;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            }
            
            .send-button {
                padding: 0.75rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            #image-upload-btn {
                min-width: 44px;
                min-height: 44px;
                padding: 0.75rem;
            }
            
            .welcome-message {
                padding: 1rem;
            }
            
            .welcome-message h2 {
                font-size: 1.25rem;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .button-gradient, .clear-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .text-area {
                padding: 0.75rem;
                font-size: 0.9rem;
                min-height: 2.5rem;
            }
            
            .send-button {
                padding: 0.75rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            #image-upload-btn {
                padding: 0.75rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            .input-container {
                padding: 1rem 0.75rem;
                margin-bottom: 1.5rem;
                background-color: white;
                border-top: 2px solid #e2e8f0;
                border-radius: 12px 12px 0 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            }
            
            .user-info {
                padding: 0.75rem 0.5rem;
            }
            
            .options-section {
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-white text-xl">Initializing...</div>
    </div>
    
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-center text-[#a37d65] mb-6">AI Study Assistant</h2>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#a37d65]" placeholder="your@email.com">
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#a37d65]" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div class="flex space-x-2">
                <button id="login-btn" class="button-gradient py-2 px-4 rounded flex-1">Login</button>
                <button id="signup-btn" class="button-gradient py-2 px-4 rounded flex-1">Sign Up</button>
            </div>
            <div id="auth-error" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="notebook-container" style="display: none;">
        <div id="error-message" class="error-message"></div>
        
        <button id="toggle-sidebar" class="toggle-sidebar-btn">â˜° History</button>
        
        <div class="main-content">
            <!-- Sidebar for History -->
            <div id="sidebar" class="sidebar">
                <h3 class="font-bold text-lg mb-4 text-[#a37d65]">Chat History</h3>
                <div id="history-list" class="history-list">
                    <!-- History items will be populated here -->
                </div>
                <button id="new-chat-btn" class="button-gradient py-2 px-4 rounded w-full mt-4">+ New Chat</button>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container">
                <div class="user-info p-4">
                    <h1 class="text-2xl sm:text-3xl font-bold text-center text-[#a37d65]">AI Study Assistant</h1>
                    <div class="mt-2">
                        <span id="user-email" class="text-sm text-gray-600 mr-4"></span>
                        <button id="logout-btn" class="text-sm text-gray-600 hover:text-[#a37d65]">Logout</button>
                    </div>
                </div>

                <!-- Chat History -->
                <div id="chat-history" class="flex-grow overflow-y-auto p-2 mb-4 rounded-lg chat-history-container">
                    <div class="welcome-message">
                        <h2 class="text-2xl font-bold text-[#a37d65] mb-4">Welcome to AI Study Assistant!</h2>
                        <p class="mb-4">Ask any study-related questions and I'll help you learn.</p>
                        <p>Try asking about a topic you're studying, or use the options below to get started.</p>
                    </div>
                </div>
                
                <!-- Options Section - Hidden on mobile for better visibility -->
                <div class="p-4 bg-gray-100 rounded-lg mb-4 options-section hidden md:block">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 options-grid">
                        <div class="flex flex-col items-start">
                            <label for="length-select" class="text-sm font-semibold text-gray-700">Response Length:</label>
                            <div class="flex items-center w-full mt-1">
                                <span id="length-value" class="text-sm text-gray-600 w-12 text-center mr-2">Normal</span>
                                <input type="range" id="length-select" min="1" max="3" value="2" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        <div class="flex items-center justify-center">
                            <button id="direct-answer-btn" class="w-full button-gradient py-2 px-4 rounded-lg shadow-sm">
                                Direct Answer
                            </button>
                        </div>
                        <div class="flex items-center justify-center">
                            <button id="quiz-btn" class="w-full button-gradient py-2 px-4 rounded-lg shadow-sm">
                                Generate Quiz
                            </button>
                        </div>
                        <div class="flex items-center justify-center">
                            <button id="easy-mode-toggle" class="w-full button-gradient py-2 px-4 rounded-lg shadow-sm" data-active="false">
                                Easy Mode: OFF
                            </button>
                        </div>
                        <div class="col-span-1 sm:col-span-2 md:col-span-4 flex items-center justify-center">
                            <button id="clear-chat-btn" class="w-full clear-btn py-2 px-4 rounded-lg shadow-sm font-semibold">
                                Clear Chat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Simplified Options for Mobile -->
                <div class="p-4 bg-gray-100 rounded-lg mb-4 options-section md:hidden">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button id="mobile-direct-answer-btn" class="button-gradient py-1 px-2 rounded text-sm">
                            Direct
                        </button>
                        <button id="mobile-easy-mode-toggle" class="button-gradient py-1 px-2 rounded text-sm" data-active="false">
                            Easy: OFF
                        </button>
                        <button id="mobile-clear-chat-btn" class="clear-btn py-1 px-2 rounded text-sm">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Image Preview Area -->
                <div id="image-preview-container" class="hidden p-4 bg-gray-50 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Image attached:</span>
                        <button id="remove-image-btn" class="text-red-500 hover:text-red-700 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    <img id="image-preview" class="max-w-full h-32 object-contain rounded-lg border" alt="Preview">
                </div>

                <!-- Input and Send Button - Back at the bottom -->
                <div class="flex items-center space-x-2 p-4 input-container">
                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button id="image-upload-btn" class="bg-gray-500 text-white p-2 sm:p-3 rounded-lg shadow-lg hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <textarea id="user-input" rows="1" class="text-area flex-grow p-3 sm:p-4 rounded-lg border-2 border-gray-300 focus:border-gray-500 transition-colors" placeholder="Type your message or ask about the image..."></textarea>
                    <button id="send-btn" class="bg-[#a37d65] text-white p-2 sm:p-3 rounded-lg shadow-lg hover:bg-[#8e6b5a] transition-colors send-button">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 sm:w-6 sm:h-6">
                            <path d="M3.478 2.405a.75.75 0 01.087 1.254l5.346 5.346a.75.75 0 01-1.06 1.06L2.405 3.565a.75.75 0 011.06-1.06zM12.75 12.75a.75.75 0 11-1.5 0 .75.75 0 011.5 0zM19.125 18.067a.75.75 0 011.061-.087l5.346-5.346a.75.75 0 011.06 1.06l-5.346 5.346a.75.75 0 01-.087-1.06zM3.478 21.595a.75.75 0 01.087-1.254l5.346-5.346a.75.75 0 011.06 1.06l-5.346 5.346a.75.75 0 01-1.06-1.06zM21.595 3.478a.75.75 0 01-1.254-.087l-5.346-5.346a.75.75 0 01-1.06 1.06l5.346 5.346a.75.75 0 01.087-1.06z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Show loading overlay immediately
        document.getElementById('loading-overlay').style.display = 'flex';
        
        // Load configuration
        let config;
        try {
            // Try to load config from window.appConfig (set by config.js)
            config = window.appConfig || {
                // Default configuration with empty values for sensitive data
                SUPABASE_URL: '',
                SUPABASE_KEY: '',
                GROQ_API_KEYS: [],
                OPENROUTER_API_KEY: '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',
                OPENROUTER_VISION_MODEL: 'x-ai/grok-vision-beta',
                MODEL_NAME: "openai/gpt-oss-120b",
                DEFAULT_TEMPERATURE: 0.7,
                MAX_CHAT_HISTORY: 10,
                MAX_COMPLETION_TOKENS: 8192,
                temperatures: {
                    direct: 0.1,
                    short: 0.4,
                    normal: 0.5,
                    detailed: 0.8
                },
                systemInstructions: {
                    base: "You are an AI Study Assistant designed to help students learn. Provide accurate, helpful, and educational responses.",
                    easyMode: "Explain all concepts in simple, easy-to-understand language for a beginner. Avoid jargon.",
                    direct: "Provide a very short, direct, and concise answer. Do not elaborate.",
                    quiz: "Generate a quiz with at least 3 questions based on the provided conversation history. Format it clearly with numbered questions and an answer key at the end.",
                    short: "Your response should be brief, a few sentences at most.",
                    detailed: "Your response should be very detailed and long, with comprehensive explanations."
                }
            };
        } catch (e) {
            console.error('Error loading configuration:', e);
            // Fallback to default configuration
            config = {
                SUPABASE_URL: '',
                SUPABASE_KEY: '',
                GROQ_API_KEYS: [],
                OPENROUTER_API_KEY: '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',
                OPENROUTER_VISION_MODEL: 'x-ai/grok-vision-beta',
                MODEL_NAME: "openai/gpt-oss-120b",
                DEFAULT_TEMPERATURE: 0.7,
                MAX_CHAT_HISTORY: 10,
                MAX_COMPLETION_TOKENS: 8192,
                temperatures: {
                    direct: 0.1,
                    short: 0.4,
                    normal: 0.5,
                    detailed: 0.8
                },
                systemInstructions: {
                    base: "You are an AI Study Assistant designed to help students learn. Provide accurate, helpful, and educational responses.",
                    easyMode: "Explain all concepts in simple, easy-to-understand language for a beginner. Avoid jargon.",
                    direct: "Provide a very short, direct, and concise answer. Do not elaborate.",
                    quiz: "Generate a quiz with at least 3 questions based on the provided conversation history. Format it clearly with numbered questions and an answer key at the end.",
                    short: "Your response should be brief, a few sentences at most.",
                    detailed: "Your response should be very detailed and long, with comprehensive explanations."
                }
            };
        }
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const userEmail = document.getElementById('user-email');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const errorMessage = document.getElementById('error-message');
        
        const chatHistoryEl = document.getElementById('chat-history');
        const userInputEl = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const lengthSelectEl = document.getElementById('length-select');
        const lengthValueEl = document.getElementById('length-value');
        const directAnswerBtn = document.getElementById('direct-answer-btn');
        const quizBtn = document.getElementById('quiz-btn');
        const easyModeToggle = document.getElementById('easy-mode-toggle');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        
        // Mobile elements
        const mobileDirectAnswerBtn = document.getElementById('mobile-direct-answer-btn');
        const mobileEasyModeToggle = document.getElementById('mobile-easy-mode-toggle');
        const mobileClearChatBtn = document.getElementById('mobile-clear-chat-btn');
        
        // Image upload elements
        const imageInput = document.getElementById('image-input');
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');

        // State variables
        let supabase = null;
        let currentApiKeyIndex = 0;
        let currentUser = null;
        let currentConversationId = null;
        let chatHistory = [];
        let isFetching = false;
        let currentImage = null;
        
        // Function to get current API key
        const getCurrentApiKey = () => {
            if (config.GROQ_API_KEYS && config.GROQ_API_KEYS.length > 0) {
                return config.GROQ_API_KEYS[currentApiKeyIndex];
            }
            return '';
        };
        
        // Function to switch to next API key
        const switchToNextApiKey = () => {
            if (config.GROQ_API_KEYS && config.GROQ_API_KEYS.length > 0) {
                currentApiKeyIndex = (currentApiKeyIndex + 1) % config.GROQ_API_KEYS.length;
            }
        };
        
        // Auth functions
        const showAuth = () => {
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            loadingOverlay.style.display = 'none';
        };
        
        const showApp = (user) => {
            currentUser = user;
            if (user && user.email) {
                userEmail.textContent = user.email;
            }
            authContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            loadingOverlay.style.display = 'none';
            startNewConversation();
            loadHistoryList();
        };
        
        const showError = (message) => {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            console.error(message);
        };
        
        const hideError = () => {
            errorMessage.style.display = 'none';
        };
        
        const showAuthError = (message) => {
            authError.textContent = message;
            authError.classList.remove('hidden');
            console.error(message);
        };
        
        const hideAuthError = () => {
            authError.classList.add('hidden');
        };
        
        const signUp = async () => {
            hideAuthError();
            
            if (!supabase) {
                showAuthError('Authentication service is not available');
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });
                
                if (error) {
                    showAuthError(error.message);
                } else {
                    showAuthError('Check your email for confirmation link');
                }
            } catch (error) {
                showAuthError('An error occurred during signup');
                console.error('Signup error:', error);
            }
        };
        
        const login = async () => {
            hideAuthError();
            
            if (!supabase) {
                showAuthError('Authentication service is not available');
                return;
            }
            
            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    showAuthError(error.message);
                } else {
                    showApp(data.user);
                }
            } catch (error) {
                showAuthError('An error occurred during login');
                console.error('Login error:', error);
            }
        };
        
        const logout = async () => {
            if (supabase) {
                try {
                    await supabase.auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            currentUser = null;
            chatHistory = [];
            currentConversationId = null;
            showAuth();
        };
        
        // History functions
        const toggleSidebar = () => {
            sidebar.classList.toggle('open');
            // Remove the automatic closing on mobile
            // The sidebar should stay open until the user closes it
        };
        
        const loadHistoryList = async () => {
            if (!supabase || !currentUser) return;
            
            try {
                // Get distinct conversations
                const { data, error } = await supabase
                    .from('user_chat_history')
                    .select('conversation_id, created_at, message')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (!error && data) {
                    // Group by conversation_id and get the first message for each
                    const conversations = {};
                    data.forEach(item => {
                        if (!conversations[item.conversation_id]) {
                            conversations[item.conversation_id] = {
                                id: item.conversation_id,
                                createdAt: item.created_at,
                                firstMessage: item.message
                            };
                        }
                    });
                    
                    // Sort conversations by creation date
                    const sortedConversations = Object.values(conversations)
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // Display conversations
                    historyList.innerHTML = '';
                    sortedConversations.forEach(conv => {
                        const preview = conv.firstMessage.length > 30 ? conv.firstMessage.substring(0, 30) + '...' : conv.firstMessage;
                        const date = new Date(conv.createdAt).toLocaleDateString();
                        
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        if (conv.id === currentConversationId) {
                            historyItem.classList.add('active');
                        }
                        historyItem.innerHTML = `
                            <div class="font-semibold">${date}</div>
                            <div class="text-gray-600 text-sm">${preview}</div>
                        `;
                        historyItem.addEventListener('click', (e) => {
                            // Prevent sidebar from closing automatically
                            e.stopPropagation();
                            loadConversation(conv.id);
                            // On mobile, we might want to close the sidebar after selecting
                            if (window.innerWidth <= 768) {
                                sidebar.classList.remove('open');
                            }
                        });
                        historyList.appendChild(historyItem);
                    });
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        };
        
        const loadConversation = async (conversationId) => {
            if (!supabase || !currentUser) return;
            
            try {
                // Clear current chat
                chatHistory = [];
                chatHistoryEl.innerHTML = '<div class="welcome-message"><h2 class="text-2xl font-bold text-[#a37d65] mb-4">Loading conversation...</h2></div>';
                
                // Load conversation from Supabase
                const { data, error } = await supabase
                    .from('user_chat_history')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('conversation_id', conversationId)
                    .order('created_at', { ascending: true });
                
                if (!error && data) {
                    // Clear welcome message
                    chatHistoryEl.innerHTML = '';
                    
                    data.forEach(item => {
                        chatHistory.push({
                            id: item.id,
                            sender: item.sender,
                            text: item.message
                        });
                        createMessageBubble(item.message, item.sender);
                    });
                    
                    // Set current conversation ID
                    currentConversationId = conversationId;
                    loadHistoryList(); // Refresh sidebar to show active conversation
                    
                    // Scroll to bottom after loading conversation
                    setTimeout(scrollToBottom, 100);
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
                chatHistoryEl.innerHTML = '';
                createMessageBubble('Error loading conversation', 'assistant');
            }
        };
        
        const startNewConversation = async () => {
            // Clear current chat
            chatHistory = [];
            chatHistoryEl.innerHTML = `
                <div class="welcome-message">
                    <h2 class="text-2xl font-bold text-[#a37d65] mb-4">New Conversation</h2>
                    <p class="mb-4">Ask any study-related questions and I'll help you learn.</p>
                    <p>Try asking about a topic you're studying, or use the options below to get started.</p>
                </div>
            `;
            
            // Generate new conversation ID
            currentConversationId = 'conv_' + Date.now();
            
            // Refresh history list
            loadHistoryList();
            
            // Scroll to top for new conversation
            chatHistoryEl.scrollTop = 0;
            
            // On mobile, close the sidebar after starting new conversation
            if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        };
        
        // Chat functions
        const scrollToBottom = () => {
            const chatHistory = document.getElementById('chat-history');
            if (chatHistory) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        };
        
        // Call this function when needed
        const createMessageBubble = (text, sender, image = null) => {
            // Remove welcome message if it exists
            const welcomeMessage = chatHistoryEl.querySelector('.welcome-message');
            if (welcomeMessage) {
                chatHistoryEl.innerHTML = '';
            }
            
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble', 'mb-2');

            if (sender === 'user') {
                bubble.classList.add('user-message', 'ml-auto');
            } else {
                bubble.classList.add('ai-message');
            }
            
            // Create content container
            const contentContainer = document.createElement('div');
            if (image) {
                contentContainer.classList.add('image-message');
                
                // Add image
                const img = document.createElement('img');
                img.src = image.data;
                img.alt = image.name || 'Uploaded image';
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '0.5rem';
                img.style.border = '1px solid #e5e7eb';
                contentContainer.appendChild(img);
                
                // Add text if present
                if (text) {
                    const textDiv = document.createElement('div');
                    textDiv.textContent = text;
                    contentContainer.appendChild(textDiv);
                }
            } else {
                contentContainer.textContent = text;
            }
            
            bubble.appendChild(contentContainer);
            chatHistoryEl.appendChild(bubble);
            scrollToBottom();
            
            // Ensure proper layout on mobile after adding message
            handleMobileLayout();
        };
        
        const saveChatHistory = async () => {
            if (!supabase || !currentUser || !currentConversationId) return;
            
            try {
                // Save to Supabase
                for (const message of chatHistory) {
                    // Only save new messages (without IDs)
                    if (!message.id) {
                        const { data, error } = await supabase
                            .from('user_chat_history')
                            .insert([
                                {
                                    user_id: currentUser.id,
                                    message: message.text,
                                    sender: message.sender,
                                    conversation_id: currentConversationId
                                }
                            ]);
                        
                        if (!error && data && data.length > 0) {
                            message.id = data[0].id;
                        }
                    }
                }
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        };

        const clearChatHistory = async () => {
            // Just start a new conversation without clearing database
            startNewConversation();
        };
        
        const showLoadingIndicator = () => {
            const loadingBubble = document.createElement('div');
            loadingBubble.classList.add('message-bubble', 'ai-message', 'loading-dots');
            loadingBubble.innerHTML = `<span>.</span><span>.</span><span>.</span>`;
            chatHistoryEl.appendChild(loadingBubble);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        };

        const hideLoadingIndicator = () => {
            const loadingBubble = chatHistoryEl.querySelector('.loading-dots');
            if (loadingBubble) {
                chatHistoryEl.removeChild(loadingBubble);
            }
        };

        const callGroqAPI = async (userPrompt, systemInstruction, temperature) => {
            if (isFetching) return;
            if (!config.GROQ_API_KEYS || config.GROQ_API_KEYS.length === 0) {
                createMessageBubble('API key not configured. Please set up your Groq API keys.', 'assistant');
                return;
            }
            
            isFetching = true;
            showLoadingIndicator();
            
            try {
                // Prepare messages for API
                const messages = [];
                
                // Add system instruction if provided
                if (systemInstruction) {
                    messages.push({ role: "system", content: systemInstruction });
                }
                
                // Add chat history (limit to last 10 messages)
                const chatHistoryForAPI = chatHistory.slice(-config.MAX_CHAT_HISTORY);
                chatHistoryForAPI.forEach(msg => {
                    messages.push({
                        role: msg.sender === 'user' ? 'user' : 'assistant',
                        content: msg.text
                    });
                });
                
                // Add current user prompt
                messages.push({ role: 'user', content: userPrompt });
                
                // Configure API request
                const payload = {
                    messages: messages,
                    model: config.MODEL_NAME,
                    temperature: temperature,
                    max_completion_tokens: config.MAX_COMPLETION_TOKENS,
                    top_p: 1,
                    stream: false,
                    reasoning_effort: "medium",
                    stop: null
                };

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getCurrentApiKey()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // If we get an error, try switching to the next API key
                    if (response.status === 429) { // Rate limit error
                        switchToNextApiKey();
                        // Retry with the new API key
                        const retryResponse = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${getCurrentApiKey()}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!retryResponse.ok) {
                            throw new Error(`HTTP error! status: ${retryResponse.status}`);
                        }
                        
                        const retryResult = await retryResponse.json();
                        const aiText = retryResult.choices[0].message.content;
                        
                        chatHistory.push({ sender: 'assistant', text: aiText });
                        await saveChatHistory();
                        hideLoadingIndicator();
                        createMessageBubble(aiText, 'assistant');
                        return;
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                
                const result = await response.json();
                const aiText = result.choices[0].message.content;
                
                chatHistory.push({ sender: 'assistant', text: aiText });
                await saveChatHistory();
                hideLoadingIndicator();
                createMessageBubble(aiText, 'assistant');

            } catch (error) {
                console.error('API call failed:', error);
                hideLoadingIndicator();
                createMessageBubble(`An error occurred: ${error.message}. Please try again.`, 'assistant');
            } finally {
                isFetching = false;
            }
        };

        const sendMessage = async (mode = 'normal') => {
            const prompt = userInputEl.value.trim();
            if (prompt === '' && !currentImage) return;
            
            const responseLength = lengthSelectEl.value;
            const isEasyMode = easyModeToggle.getAttribute('data-active') === 'true';
            
            // Create message object
            const messageData = { 
                sender: 'user', 
                text: prompt || 'What can you tell me about this image?'
            };
            
            // Add image data if present
            if (currentImage) {
                messageData.image = currentImage;
            }
            
            // Add user message to history
            chatHistory.push(messageData);
            createMessageBubble(messageData.text, 'user', currentImage);
            await saveChatHistory();
            userInputEl.value = '';
            
            // Clear image after sending
            const imageToSend = currentImage;
            removeImage();

            let systemInstruction = config.systemInstructions.base;
            let temperature = config.DEFAULT_TEMPERATURE;

            if (isEasyMode) {
                systemInstruction += ' ' + config.systemInstructions.easyMode;
            }

            switch (mode) {
                case 'direct':
                    systemInstruction = config.systemInstructions.direct;
                    temperature = config.temperatures.direct;
                    break;
                case 'quiz':
                    systemInstruction += ' ' + config.systemInstructions.quiz;
                    temperature = config.temperatures.detailed;
                    break;
                case 'normal':
                    if (responseLength === '1') {
                        systemInstruction += ' ' + config.systemInstructions.short;
                        temperature = config.temperatures.short;
                    } else if (responseLength === '3') {
                        systemInstruction += ' ' + config.systemInstructions.detailed;
                        temperature = config.temperatures.detailed;
                    }
                    break;
            }

            // Handle image analysis
            if (imageToSend) {
                console.log('ðŸ–¼ï¸ Image detected, starting vision analysis...');
                // Use OpenRouter with Grok vision model for image analysis
                showLoadingIndicator();
                
                try {
                    const visionResponse = await analyzeImageWithOpenRouter(prompt, imageToSend);
                    hideLoadingIndicator();
                    
                    if (visionResponse) {
                        console.log('âœ… Vision analysis successful!');
                        chatHistory.push({ sender: 'assistant', text: visionResponse });
                        createMessageBubble(visionResponse, 'assistant');
                        await saveChatHistory();
                        return;
                    } else {
                        console.log('âŒ Vision analysis failed, falling back to text mode');
                        // Fallback to helpful text-based guidance
                        const fallbackPrompt = prompt || "I can see you've uploaded an image, but I'm currently unable to analyze images directly. Please describe what you see in the image or tell me what specific questions you have about it, and I'll do my best to help you with your studies.";
                        await callGroqAPI(fallbackPrompt, systemInstruction, temperature);
                        return;
                    }
                } catch (error) {
                    console.error('ðŸ’¥ Error in image analysis:', error);
                    hideLoadingIndicator();
                    // Fallback to text mode
                    const fallbackPrompt = prompt || "I encountered an error while analyzing the image. Please describe what you see in the image or tell me what specific questions you have about it, and I'll do my best to help you with your studies.";
                    await callGroqAPI(fallbackPrompt, systemInstruction, temperature);
                    return;
                }
            } else {
                await callGroqAPI(prompt, systemInstruction, temperature);
            }
        };

        // Image handling functions
        const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // Check file size (limit to 20MB for API compatibility)
                if (file.size > 20 * 1024 * 1024) {
                    alert('Image size too large. Please choose an image smaller than 20MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImage = {
                        data: e.target.result,
                        name: file.name,
                        type: file.type
                    };
                    showImagePreview(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        };
        
        const showImagePreview = (imageSrc) => {
            imagePreview.src = imageSrc;
            imagePreviewContainer.classList.remove('hidden');
            userInputEl.placeholder = 'Ask a question about this image...';
        };
        
        const removeImage = () => {
            currentImage = null;
            imagePreviewContainer.classList.add('hidden');
            imageInput.value = '';
            userInputEl.placeholder = 'Type your message...';
        };
        
        const convertImageToBase64 = (imageData) => {
            // Remove data URL prefix if present
            return imageData.split(',')[1] || imageData;
        };
        
        // Function to analyze image using OpenRouter with Grok vision model
        const analyzeImageWithOpenRouter = async (userPrompt, image) => {
            console.log('ðŸ” Starting image analysis with OpenRouter...');
            console.log('API Key:', config.OPENROUTER_API_KEY ? 'Present' : 'Missing');
            console.log('Model:', config.OPENROUTER_VISION_MODEL || "x-ai/grok-vision-beta");
            console.log('Image data length:', image.data ? image.data.length : 'No image data');
            
            try {
                const payload = {
                    model: "x-ai/grok-vision-beta",
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: userPrompt || "Please analyze this image and help me understand what I'm looking at. Explain any concepts, problems, or educational content you can see."
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: image.data
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 2000,
                    temperature: 0.7
                };
                
                console.log('ðŸ“¤ Sending request to OpenRouter...');
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.origin,
                        'X-Title': 'AI Study Assistant'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('ðŸ“¥ Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… OpenRouter response received:', data);
                    return data.choices[0].message.content;
                } else {
                    const errorText = await response.text();
                    console.error(`âŒ OpenRouter API error: ${response.status}`, errorText);
                    
                    // Try with a different model if grok-vision-beta fails
                    if (response.status === 400) {
                        console.log('ðŸ”„ Trying with Google Gemini Flash...');
                        const fallbackPayload = {
                            ...payload,
                            model: "meta-llama/llama-3.2-11b-vision-instruct:free"
                        };
                        
                        const fallbackResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer 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',
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin,
                                'X-Title': 'AI Study Assistant'
                            },
                            body: JSON.stringify(fallbackPayload)
                        });
                        
                        if (fallbackResponse.ok) {
                            const fallbackData = await fallbackResponse.json();
                            console.log('âœ… Fallback model response received:', fallbackData);
                            return fallbackData.choices[0].message.content;
                        }
                    }
                    
                    throw new Error(`OpenRouter API error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('ðŸ’¥ OpenRouter API error:', error);
                return null;
            }
        };

        // Event Listeners
        if (loginBtn) loginBtn.addEventListener('click', login);
        if (signupBtn) signupBtn.addEventListener('click', signUp);
        if (logoutBtn) logoutBtn.addEventListener('click', logout);
        if (toggleSidebarBtn) toggleSidebarBtn.addEventListener('click', toggleSidebar);
        if (newChatBtn) newChatBtn.addEventListener('click', startNewConversation);
        
        if (sendBtn) sendBtn.addEventListener('click', () => sendMessage('normal'));
        if (userInputEl) userInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage('normal');
            }
        });

        if (lengthSelectEl) lengthSelectEl.addEventListener('input', () => {
            const value = lengthSelectEl.value;
            let label = '';
            switch (value) {
                case '1':
                    label = 'Short';
                    break;
                case '2':
                    label = 'Normal';
                    break;
                case '3':
                    label = 'Detailed';
                    break;
            }
            if (lengthValueEl) lengthValueEl.textContent = label;
        });

        if (directAnswerBtn) directAnswerBtn.addEventListener('click', () => sendMessage('direct'));
        if (quizBtn) quizBtn.addEventListener('click', () => sendMessage('quiz'));
        
        if (easyModeToggle) easyModeToggle.addEventListener('click', () => {
            const isActive = easyModeToggle.getAttribute('data-active') === 'true';
            easyModeToggle.setAttribute('data-active', !isActive);
            easyModeToggle.textContent = `Easy Mode: ${!isActive ? 'ON' : 'OFF'}`;
            easyModeToggle.classList.toggle('bg-[#c8a48b]');
            easyModeToggle.classList.toggle('bg-[#a37d65]');
        });

        if (clearChatBtn) clearChatBtn.addEventListener('click', async () => {
            await clearChatHistory();
        });
        
        // Mobile button event listeners
        if (mobileDirectAnswerBtn) mobileDirectAnswerBtn.addEventListener('click', () => sendMessage('direct'));
        if (mobileEasyModeToggle) mobileEasyModeToggle.addEventListener('click', () => {
            const isActive = mobileEasyModeToggle.getAttribute('data-active') === 'true';
            mobileEasyModeToggle.setAttribute('data-active', !isActive);
            mobileEasyModeToggle.textContent = `Easy: ${!isActive ? 'ON' : 'OFF'}`;
            mobileEasyModeToggle.classList.toggle('bg-[#c8a48b]');
            mobileEasyModeToggle.classList.toggle('bg-[#a37d65]');
            
            // Also update the desktop version for consistency
            if (easyModeToggle) {
                easyModeToggle.setAttribute('data-active', !isActive);
                easyModeToggle.textContent = `Easy Mode: ${!isActive ? 'ON' : 'OFF'}`;
                easyModeToggle.classList.toggle('bg-[#c8a48b]');
                easyModeToggle.classList.toggle('bg-[#a37d65]');
            }
        });
        if (mobileClearChatBtn) mobileClearChatBtn.addEventListener('click', async () => {
            await clearChatHistory();
        });
        
        // Image upload event listeners
        if (imageUploadBtn) imageUploadBtn.addEventListener('click', () => {
            imageInput.click();
        });
        
        if (imageInput) imageInput.addEventListener('change', handleImageUpload);
        if (removeImageBtn) removeImageBtn.addEventListener('click', removeImage);

        // Mobile-specific enhancements
        const handleMobileLayout = () => {
            const isMobile = window.innerWidth <= 768;
            
            // Remove automatic sidebar closing on mobile
            // Keep the sidebar state as is
            
            // Adjust chat history container height for mobile
            const chatHistory = document.getElementById('chat-history');
            if (chatHistory) {
                if (isMobile) {
                    // Calculate height based on viewport and other elements
                    const viewportHeight = window.innerHeight;
                    const headerHeight = document.querySelector('.user-info')?.offsetHeight || 80;
                    const mobileOptionsHeight = document.querySelector('.options-section:not(.md\\:block)')?.offsetHeight || 40;
                    const inputHeight = document.querySelector('.input-container')?.offsetHeight || 80;
                    
                    const availableHeight = viewportHeight - headerHeight - mobileOptionsHeight - inputHeight - 20;
                    chatHistory.style.height = Math.max(availableHeight, 150) + 'px';
                } else {
                    chatHistory.style.height = 'calc(100vh - 250px)';
                }
            }
            
            // Ensure input area is visible and properly positioned
            const inputContainer = document.querySelector('.input-container');
            if (inputContainer) {
                inputContainer.style.position = 'sticky';
                inputContainer.style.bottom = '0';
            }
            
            // Adjust textarea height based on content
            if (userInputEl) {
                userInputEl.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    // Limit maximum height
                    if (this.scrollHeight > 150) {
                        this.style.overflowY = 'scroll';
                    } else {
                        this.style.overflowY = 'hidden';
                    }
                });
            }
        };

        // Handle window resize events
        window.addEventListener('resize', function() {
            handleMobileLayout();
            // Also scroll to bottom of chat when resizing
            const chatHistory = document.getElementById('chat-history');
            if (chatHistory) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });

        // Initialize Supabase
        const initializeSupabase = () => {
            try {
                if (config.SUPABASE_URL && config.SUPABASE_KEY) {
                    supabase = window.supabase.createClient(config.SUPABASE_URL, config.SUPABASE_KEY);
                    console.log('Supabase initialized successfully');
                } else {
                    console.warn('Supabase configuration missing');
                }
            } catch (error) {
                console.error('Supabase initialization error:', error);
                showError('Failed to initialize Supabase. Some features may not work properly.');
            }
        };

        // Check user session on load
        const checkSession = async () => {
            initializeSupabase();
            
            if (!supabase) {
                // Show app without auth if Supabase is not available
                showApp(null);
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    showApp(session.user);
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Session check error:', error);
                showAuth();
            }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkSession();
                handleMobileLayout(); // Apply mobile layout fixes on load
                scrollToBottom(); // Ensure chat is scrolled to bottom on load
            }, 1000); // Give a small delay to ensure all resources are loaded
        });
        
        // Listen for auth changes
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    showApp(session.user);
                } else if (event === 'SIGNED_OUT') {
                    showAuth();
                }
            });
        }
    </script>
</body>
</html>
